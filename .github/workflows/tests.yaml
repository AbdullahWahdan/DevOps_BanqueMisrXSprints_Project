name: CI - Tests

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      test-result:
        description: "Test results"
        value: ${{ jobs.unit_testing.outputs.result }}
      coverage-result:
        description: "Coverage report"
        value: ${{ jobs.code-coverage.outputs.result }}

jobs:
  unit_testing:
    runs-on: ubuntu-latest
    env:
        MONGO_URI: 'mongodb+srv://supercluster.d83jj.mongodb.net/superData'
        MONGO_USERNAME: ${{ vars.MONGO_USERNAME }}
    outputs:
      result: ${{ steps.test_step.outputs.result }}
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install
      - id: test_step
        env:
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
        run: |
          # Debug: Check if environment variables are set
          echo "MONGO_URI: $MONGO_URI"
          echo "MONGO_USERNAME: $MONGO_USERNAME"
          echo "MONGO_PASSWORD: $MONGO_PASSWORD"
          echo "MONGO_PASSWORD length: ${#MONGO_PASSWORD}"
          echo "MONGO_PASSWORD is empty: $([ -z "$MONGO_PASSWORD" ] && echo "YES" || echo "NO")"
          
          # Debug: Check if the secret is being passed correctly
          echo "Testing secret access:"
          if [ -n "${{ secrets.MONGO_PASSWORD }}" ]; then
            echo "Secret MONGO_PASSWORD is set (length: ${#MONGO_PASSWORD})"
          else
            echo "Secret MONGO_PASSWORD is NOT set"
          fi
          
          if npm test; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  code-coverage:
    needs: unit_testing
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.coverage_step.outputs.result }}
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install
      - id: coverage_step
        run: |
          if npm run coverage; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failuree" >> $GITHUB_OUTPUT
          fi
